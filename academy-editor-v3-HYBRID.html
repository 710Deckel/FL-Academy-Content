<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéì Academy Content Editor - FL Mastery</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 2rem;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: white;
            color: #667eea;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-secondary {
            background: #718096;
            color: white;
        }

        .btn-warning {
            background: #ed8936;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            height: calc(100vh - 150px);
        }

        .sidebar {
            background: #f7fafc;
            border-right: 2px solid #e2e8f0;
            overflow-y: auto;
            padding: 20px;
        }

        .module-section {
            margin-bottom: 30px;
        }

        .module-header {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 15px;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .module-header:hover {
            background: #edf2f7;
        }

        .lektion-item {
            padding: 12px;
            margin-bottom: 8px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .lektion-item:hover {
            border-color: #667eea;
            transform: translateX(5px);
        }

        .lektion-item.active {
            border-color: #667eea;
            background: #edf2f7;
        }

        .lektion-title {
            font-weight: 600;
            color: #2d3748;
            font-size: 0.9rem;
        }

        .lektion-status {
            display: flex;
            gap: 5px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #cbd5e0;
        }

        .status-dot.checked {
            background: #48bb78;
        }

        .add-lektion-btn {
            width: 100%;
            margin-top: 10px;
            padding: 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .add-lektion-btn:hover {
            background: #5568d3;
        }

        .editor-area {
            padding: 30px;
            overflow-y: auto;
        }

        .empty-state {
            text-align: center;
            padding: 100px 20px;
            color: #718096;
        }

        .empty-state-icon {
            font-size: 5rem;
            margin-bottom: 20px;
        }

        .editor-section {
            margin-bottom: 30px;
        }

        .editor-section h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.3s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            min-height: 200px;
            resize: vertical;
        }

        .checkbox-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            user-select: none;
        }

        .checkbox-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .lernziele-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .lernziel-item {
            display: flex;
            gap: 10px;
        }

        .lernziel-item input {
            flex: 1;
        }

        .lernziel-item button {
            padding: 10px 15px;
            background: #f56565;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .add-item-btn {
            padding: 10px 20px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
        }

        .beispiele-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .beispiel-item {
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
        }

        .beispiel-item textarea {
            min-height: 100px;
            margin-bottom: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #718096;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border: 2px solid #9ae6b4;
        }

        .alert-info {
            background: #bee3f8;
            color: #2c5282;
            border: 2px solid #90cdf4;
        }

        .print-options {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .print-module {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
        }

        .print-module-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .print-lektion {
            margin-left: 30px;
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .container {
                box-shadow: none;
                border-radius: 0;
            }

            .no-print {
                display: none !important;
            }

            .print-content {
                page-break-inside: avoid;
            }

            .print-lektion-content {
                page-break-inside: avoid;
                margin-bottom: 40px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header no-print">
            <div>
                <h1>üéì Academy Content Editor</h1>
                <p style="margin-top: 5px; opacity: 0.9;">FL Mastery Pro - Fahrlehrerausbildung</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="openSettingsModal()">
                    ‚öôÔ∏è GitHub Setup
                </button>
                <button class="btn btn-warning" onclick="openPrintModal()">
                    üñ®Ô∏è Drucken
                </button>
                <button class="btn btn-primary" onclick="loadFromGitHub()">
                    üì• Laden
                </button>
                <button class="btn btn-success" onclick="saveToGitHub()">
                    üíæ Speichern
                </button>
            </div>
        </div>

        <div class="main-content no-print">
            <div class="sidebar">
                <div id="modulesList">
                    <!-- Module werden hier dynamisch eingef√ºgt -->
                </div>
            </div>

            <div class="editor-area">
                <div id="emptyState" class="empty-state">
                    <div class="empty-state-icon">üìö</div>
                    <h2>Willkommen im Academy Editor!</h2>
                    <p style="margin: 20px 0;">Klicke auf "GitHub Setup" um zu starten.</p>
                    <p>Daten werden als <strong>HTML-Datei</strong> auf GitHub gespeichert (wie Gesetze).</p>
                    <div class="alert alert-info" style="margin-top: 30px; text-align: left;">
                        <span style="font-size: 1.5rem;">üí°</span>
                        <div>
                            <strong>Vorteil:</strong> Unbegrenzte Gr√∂√üe! HTML kann beliebig gro√ü werden.<br>
                            Die App l√§dt die HTML-Datei direkt von GitHub - genau wie bei den Gesetzen!
                        </div>
                    </div>
                </div>

                <div id="editorContent" style="display: none;">
                    <!-- Editor wird hier angezeigt -->
                </div>
            </div>
        </div>

        <!-- PRINT AREA -->
        <div id="printArea" style="display: none;">
            <!-- Druck-Inhalt wird hier generiert -->
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è GitHub Einstellungen</h2>
                <button class="modal-close" onclick="closeSettingsModal()">√ó</button>
            </div>
            
            <div class="form-group">
                <label>GitHub Token (Personal Access Token)</label>
                <input type="password" id="githubToken" placeholder="ghp_...">
                <small style="color: #718096; display: block; margin-top: 5px;">
                    Erstelle einen Token unter: github.com/settings/tokens
                </small>
            </div>

            <div class="form-group">
                <label>Repository Name</label>
                <input type="text" id="repoName" value="FL-Academy-Content">
            </div>

            <div class="form-group">
                <label>Dateiname</label>
                <input type="text" id="fileName" value="academy-content.html">
                <small style="color: #718096; display: block; margin-top: 5px;">
                    Wird als HTML gespeichert (wie Gesetze-Datenbank)
                </small>
            </div>

            <button class="btn btn-success" onclick="saveSettings()" style="width: 100%; margin-top: 20px;">
                ‚úÖ Einstellungen speichern
            </button>
        </div>
    </div>

    <!-- PRINT MODAL -->
    <div class="modal" id="printModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üñ®Ô∏è Druckauswahl</h2>
                <button class="modal-close" onclick="closePrintModal()">√ó</button>
            </div>

            <div class="alert alert-info">
                <span style="font-size: 1.5rem;">üìã</span>
                <div>
                    W√§hle aus, was du drucken m√∂chtest. Der Ausdruck enth√§lt automatisch den FL Mastery Footer.
                </div>
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="printAnwaerter" checked>
                    <span>üìñ Anw√§rter-Inhalte drucken</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="printDozent" checked>
                    <span>üë®‚Äçüè´ Dozenten-Inhalte drucken</span>
                </label>
            </div>

            <div id="printSelection" class="print-options">
                <!-- Auswahloptionen werden hier generiert -->
            </div>

            <div style="display: flex; gap: 10px; margin-top: 30px;">
                <button class="btn btn-success" onclick="executePrint()" style="flex: 1;">
                    üñ®Ô∏è Jetzt drucken
                </button>
                <button class="btn btn-secondary" onclick="closePrintModal()">
                    Abbrechen
                </button>
            </div>
        </div>
    </div>

    <script>
        // ======================
        // GLOBALE VARIABLEN
        // ======================
        let academyData = {
            modules: [
                { id: 'verkehrsverhalten', name: 'Verkehrsverhalten', icon: 'üöó', lektionen: [] },
                { id: 'recht', name: 'Recht', icon: '‚öñÔ∏è', lektionen: [] },
                { id: 'technik', name: 'Technik', icon: 'üîß', lektionen: [] },
                { id: 'ausbilden', name: 'Didaktik & Methodik', icon: 'üë®‚Äçüè´', lektionen: [] },
                { id: 'erziehen', name: 'P√§dagogische Psychologie', icon: 'üå±', lektionen: [] },
                { id: 'beurteilen', name: 'Leistungsbeurteilung', icon: 'üìä', lektionen: [] }
            ]
        };

        let currentLektion = null;
        let githubSettings = {
            token: localStorage.getItem('github_token') || '',
            repo: localStorage.getItem('github_repo') || 'FL-Academy-Content',
            file: localStorage.getItem('github_file') || 'academy-content.html'
        };

        // ======================
        // INITIALISIERUNG
        // ======================
        window.addEventListener('load', () => {
            renderModules();
            
            if (githubSettings.token) {
                document.getElementById('githubToken').value = githubSettings.token;
                document.getElementById('repoName').value = githubSettings.repo;
                document.getElementById('fileName').value = githubSettings.file;
            }

            console.log('üéì Academy Editor geladen - HTML-Speicher-Modus!');
        });

        // ======================
        // SETTINGS MODAL
        // ======================
        function openSettingsModal() {
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function saveSettings() {
            githubSettings.token = document.getElementById('githubToken').value;
            githubSettings.repo = document.getElementById('repoName').value;
            githubSettings.file = document.getElementById('fileName').value;

            localStorage.setItem('github_token', githubSettings.token);
            localStorage.setItem('github_repo', githubSettings.repo);
            localStorage.setItem('github_file', githubSettings.file);

            alert('‚úÖ Einstellungen gespeichert!');
            closeSettingsModal();
        }

        // ======================
        // RENDER FUNCTIONS (gleich wie vorher)
        // ======================
        function renderModules() {
            const container = document.getElementById('modulesList');
            container.innerHTML = '';

            academyData.modules.forEach(modul => {
                const section = document.createElement('div');
                section.className = 'module-section';

                const header = document.createElement('div');
                header.className = 'module-header';
                header.innerHTML = `
                    <span>${modul.icon}</span>
                    <span>${modul.name}</span>
                `;
                section.appendChild(header);

                modul.lektionen.forEach((lektion, index) => {
                    const item = document.createElement('div');
                    item.className = 'lektion-item';
                    if (currentLektion && currentLektion.id === lektion.id) {
                        item.classList.add('active');
                    }
                    
                    item.innerHTML = `
                        <div class="lektion-title">${lektion.titel || 'Neue Lektion'}</div>
                        <div class="lektion-status">
                            <div class="status-dot ${lektion.status_justin ? 'checked' : ''}" title="Justin gepr√ºft"></div>
                            <div class="status-dot ${lektion.status_dozent ? 'checked' : ''}" title="Dozent gepr√ºft"></div>
                        </div>
                    `;
                    
                    item.onclick = () => editLektion(modul.id, index);
                    section.appendChild(item);
                });

                const addBtn = document.createElement('button');
                addBtn.className = 'add-lektion-btn';
                addBtn.textContent = '+ Neue Lektion';
                addBtn.onclick = () => addNewLektion(modul.id);
                section.appendChild(addBtn);

                container.appendChild(section);
            });
        }

        function addNewLektion(modulId) {
            const modul = academyData.modules.find(m => m.id === modulId);
            if (!modul) return;

            const newLektion = {
                id: `${modulId}_${Date.now()}`,
                titel: '',
                dauer: 90,
                pruefungsrelevant: false,
                status_justin: false,
                status_dozent: false,
                lernziele: [''],
                inhalt_anwaerter: '',
                beispiele: [''],
                inhalt_dozent: '',
                unterrichtsentwurf: '',
                didaktik: '',
                pruefungsfragen_text: ''
            };

            modul.lektionen.push(newLektion);
            renderModules();
            editLektion(modulId, modul.lektionen.length - 1);
        }

        function editLektion(modulId, lektionIndex) {
            const modul = academyData.modules.find(m => m.id === modulId);
            if (!modul) return;

            currentLektion = modul.lektionen[lektionIndex];
            
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('editorContent').style.display = 'block';

            renderEditor();
            renderModules();
        }

        function renderEditor() {
            if (!currentLektion) return;

            const container = document.getElementById('editorContent');
            container.innerHTML = `
                <div class="editor-section">
                    <h3>üìù Basis-Informationen</h3>
                    
                    <div class="form-group">
                        <label>Titel der Lektion</label>
                        <input type="text" id="titel" value="${currentLektion.titel || ''}" onchange="updateField('titel', this.value)">
                    </div>

                    <div class="form-group">
                        <label>Dauer (Minuten)</label>
                        <input type="number" id="dauer" value="${currentLektion.dauer}" onchange="updateField('dauer', parseInt(this.value))">
                    </div>

                    <div class="form-group">
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" ${currentLektion.pruefungsrelevant ? 'checked' : ''} onchange="updateField('pruefungsrelevant', this.checked)">
                                <span>üî¥ Pr√ºfungsrelevant</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" ${currentLektion.status_justin ? 'checked' : ''} onchange="updateField('status_justin', this.checked)">
                                <span>‚úÖ Von Justin gepr√ºft</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" ${currentLektion.status_dozent ? 'checked' : ''} onchange="updateField('status_dozent', this.checked)">
                                <span>üë®‚Äçüè´ Von Dozent gepr√ºft</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="editor-section">
                    <h3>üéØ Lernziele</h3>
                    <div class="lernziele-list" id="lernzieleList"></div>
                    <button class="add-item-btn" onclick="addLernziel()">+ Lernziel hinzuf√ºgen</button>
                </div>

                <div class="editor-section">
                    <h3>üéì Inhalt f√ºr Anw√§rter</h3>
                    <div class="form-group">
                        <textarea onchange="updateField('inhalt_anwaerter', this.value)">${currentLektion.inhalt_anwaerter || ''}</textarea>
                    </div>
                </div>

                <div class="editor-section">
                    <h3>üí° Praxisbeispiele</h3>
                    <div class="beispiele-list" id="beispieleList"></div>
                    <button class="add-item-btn" onclick="addBeispiel()">+ Beispiel hinzuf√ºgen</button>
                </div>

                <div class="editor-section">
                    <h3>üë®‚Äçüè´ Inhalt f√ºr Dozenten</h3>
                    
                    <div class="form-group">
                        <label>Unterrichtsentwurf</label>
                        <textarea onchange="updateField('unterrichtsentwurf', this.value)">${currentLektion.unterrichtsentwurf || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label>Didaktische Hinweise</label>
                        <textarea onchange="updateField('didaktik', this.value)">${currentLektion.didaktik || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label>Typische Pr√ºfungsfragen</label>
                        <textarea placeholder="Frage 1: ...\\nAntwort: ...\\n\\nFrage 2: ...\\nAntwort: ..." onchange="updateField('pruefungsfragen_text', this.value)">${currentLektion.pruefungsfragen_text || ''}</textarea>
                    </div>
                </div>

                <div style="display: flex; gap: 15px; margin-top: 30px;">
                    <button class="btn btn-secondary" onclick="deleteLektion()">üóëÔ∏è Lektion l√∂schen</button>
                </div>
            `;

            renderLernziele();
            renderBeispiele();
        }

        function renderLernziele() {
            if (!currentLektion) return;
            const container = document.getElementById('lernzieleList');
            container.innerHTML = '';

            currentLektion.lernziele.forEach((lernziel, index) => {
                const item = document.createElement('div');
                item.className = 'lernziel-item';
                item.innerHTML = `
                    <input type="text" value="${lernziel}" onchange="updateLernziel(${index}, this.value)">
                    <button onclick="removeLernziel(${index})">√ó</button>
                `;
                container.appendChild(item);
            });
        }

        function renderBeispiele() {
            if (!currentLektion) return;
            const container = document.getElementById('beispieleList');
            container.innerHTML = '';

            currentLektion.beispiele.forEach((beispiel, index) => {
                const item = document.createElement('div');
                item.className = 'beispiel-item';
                item.innerHTML = `
                    <textarea onchange="updateBeispiel(${index}, this.value)">${beispiel}</textarea>
                    <button class="btn btn-secondary" onclick="removeBeispiel(${index})">üóëÔ∏è Entfernen</button>
                `;
                container.appendChild(item);
            });
        }

        // ======================
        // UPDATE FUNCTIONS
        // ======================
        function updateField(field, value) {
            if (!currentLektion) return;
            currentLektion[field] = value;
            renderModules();
        }

        function updateLernziel(index, value) {
            if (!currentLektion) return;
            currentLektion.lernziele[index] = value;
        }

        function addLernziel() {
            if (!currentLektion) return;
            currentLektion.lernziele.push('');
            renderLernziele();
        }

        function removeLernziel(index) {
            if (!currentLektion) return;
            currentLektion.lernziele.splice(index, 1);
            renderLernziele();
        }

        function updateBeispiel(index, value) {
            if (!currentLektion) return;
            currentLektion.beispiele[index] = value;
        }

        function addBeispiel() {
            if (!currentLektion) return;
            currentLektion.beispiele.push('');
            renderBeispiele();
        }

        function removeBeispiel(index) {
            if (!currentLektion) return;
            currentLektion.beispiele.splice(index, 1);
            renderBeispiele();
        }

        function deleteLektion() {
            if (!currentLektion) return;
            if (!confirm('Lektion wirklich l√∂schen?')) return;

            academyData.modules.forEach(modul => {
                const index = modul.lektionen.findIndex(l => l.id === currentLektion.id);
                if (index !== -1) {
                    modul.lektionen.splice(index, 1);
                }
            });

            currentLektion = null;
            renderModules();
            
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('editorContent').style.display = 'none';
            
            alert('‚ö†Ô∏è Lektion gel√∂scht! WICHTIG: Jetzt auf GitHub speichern!');
        }

        // ======================
        // GITHUB INTEGRATION (HTML-Format!)
        // ======================
        async function saveToGitHub() {
            if (!githubSettings.token) {
                alert('‚ùå Bitte erst GitHub Token in Einstellungen hinterlegen!');
                openSettingsModal();
                return;
            }

            if (!confirm('Wirklich auf GitHub speichern? (Speichert 3 separate Dateien)')) return;

            try {
                // ===================================
                // NEUE LOGIK: SPEICHERE 3 DATEIEN!
                // ===================================
                
                // Generiere vollst√§ndiges HTML
                const fullHTML = generateAcademyHTML();
                
                // Finde Module-Positionen im generierten HTML
                const verkehrStart = fullHTML.indexOf('<!-- MODUL: VERKEHRSVERHALTEN -->');
                const rechtStart = fullHTML.indexOf('<!-- MODUL: RECHT -->');
                const technikStart = fullHTML.indexOf('<!-- MODUL: TECHNIK -->');
                const didaktikStart = fullHTML.indexOf('<!-- MODUL: DIDAKTIK');
                
                // Header und Footer
                const header = fullHTML.substring(0, fullHTML.indexOf('<div id="academy-data">') + '<div id="academy-data">'.length);
                const footer = '\n    </div>\n</body>\n</html>';
                
                // Teil 1: Verkehrsverhalten + Recht
                const part1 = header + fullHTML.substring(verkehrStart, technikStart) + footer;
                
                // Teil 2: Technik
                const part2 = header + fullHTML.substring(technikStart, didaktikStart) + footer;
                
                // Teil 3: Didaktik + Rest
                const endIndex = fullHTML.indexOf('</div>\n</body>');
                const part3 = header + fullHTML.substring(didaktikStart, endIndex) + footer;
                
                console.log(`üì¶ Teil 1: ${part1.length} Zeichen`);
                console.log(`üì¶ Teil 2: ${part2.length} Zeichen`);
                console.log(`üì¶ Teil 3: ${part3.length} Zeichen`);
                
                // Speichere alle 3 Dateien
                const files = [
                    { name: 'academy-content-part1.json', content: part1 },
                    { name: 'academy-content-part2.json', content: part2 },
                    { name: 'academy-content-part3.json', content: part3 }
                ];
                
                let successCount = 0;
                
                for (const file of files) {
                    try {
                        const encodedContent = btoa(unescape(encodeURIComponent(file.content)));
                        
                        // Get current SHA
                        let sha = null;
                        try {
                            const getResponse = await fetch(`https://api.github.com/repos/710Deckel/${githubSettings.repo}/contents/${file.name}`, {
                                headers: {
                                    'Authorization': `token ${githubSettings.token}`,
                                    'Accept': 'application/vnd.github.v3+json'
                                }
                            });
                            if (getResponse.ok) {
                                const data = await getResponse.json();
                                sha = data.sha;
                            }
                        } catch (e) {
                            console.log(`${file.name} existiert noch nicht, erstelle neu...`);
                        }

                        // Save
                        const response = await fetch(`https://api.github.com/repos/710Deckel/${githubSettings.repo}/contents/${file.name}`, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `token ${githubSettings.token}`,
                                'Accept': 'application/vnd.github.v3+json',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                message: `Update Academy Content ${file.name} - ${new Date().toLocaleString('de-DE')}`,
                                content: encodedContent,
                                ...(sha && { sha })
                            })
                        });

                        if (response.ok) {
                            console.log(`‚úÖ ${file.name} gespeichert!`);
                            successCount++;
                        } else {
                            const error = await response.json();
                            console.error(`‚ùå Fehler bei ${file.name}:`, error.message);
                        }
                    } catch (error) {
                        console.error(`‚ùå Fehler bei ${file.name}:`, error);
                    }
                }
                
                if (successCount === 3) {
                    alert('‚úÖ Erfolgreich auf GitHub gespeichert! (3 Dateien)');
                } else {
                    alert(`‚ö†Ô∏è Nur ${successCount} von 3 Dateien gespeichert!`);
                }
                
            } catch (error) {
                alert('‚ùå Fehler: ' + error.message);
            }
        }

        function generateAcademyHTML() {
            let html = `<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academy Content - FL Mastery Pro</title>
    <meta name="description" content="Fahrlehrerausbildung Unterrichtsinhalte">
    <meta name="version" content="1.0.0">
    <meta name="last-updated" content="${new Date().toISOString()}">
</head>
<body>
    <div id="academy-data">
`;

            academyData.modules.forEach(modul => {
                if (modul.lektionen.length === 0) return;
                
                html += `
        <!-- ============================================ -->
        <!-- MODUL: ${modul.name.toUpperCase()} -->
        <!-- ============================================ -->
        <div class="modul" data-id="${modul.id}" data-icon="${modul.icon}">
            <h2>${modul.name}</h2>
`;

                modul.lektionen.forEach(lektion => {
                    html += `
            <div class="lektion" 
                 data-id="${lektion.id}" 
                 data-pruefung="${lektion.pruefungsrelevant}"
                 data-dauer="${lektion.dauer}"
                 data-status-justin="${lektion.status_justin}"
                 data-status-dozent="${lektion.status_dozent}">
                
                <h3>${escapeHtml(lektion.titel)}</h3>
                
                <div class="lernziele">
${lektion.lernziele.map(z => `                    <div class="lernziel">${escapeHtml(z)}</div>`).join('\n')}
                </div>
                
                <div class="anwaerter">
                    <h4>Inhalt f√ºr Anw√§rter</h4>
                    <div class="inhalt">${escapeHtml(lektion.inhalt_anwaerter).replace(/\n/g, '<br>')}</div>
                    
${lektion.beispiele.filter(b => b.trim()).length > 0 ? `                    <div class="beispiele">
                        <h5>Praxisbeispiele</h5>
${lektion.beispiele.filter(b => b.trim()).map(b => `                        <div class="beispiel">${escapeHtml(b)}</div>`).join('\n')}
                    </div>` : ''}
                </div>
                
                <div class="dozent">
                    <h4>Inhalt f√ºr Dozenten</h4>
                    
${lektion.unterrichtsentwurf ? `                    <div class="unterrichtsentwurf">
                        <h5>Unterrichtsentwurf</h5>
                        <div class="inhalt">${escapeHtml(lektion.unterrichtsentwurf).replace(/\n/g, '<br>')}</div>
                    </div>
` : ''}
${lektion.didaktik ? `                    <div class="didaktik">
                        <h5>Didaktische Hinweise</h5>
                        <div class="inhalt">${escapeHtml(lektion.didaktik).replace(/\n/g, '<br>')}</div>
                    </div>
` : ''}
${lektion.pruefungsfragen_text ? `                    <div class="pruefungsfragen">
                        <h5>Typische Pr√ºfungsfragen</h5>
                        <div class="inhalt">${escapeHtml(lektion.pruefungsfragen_text).replace(/\n/g, '<br>')}</div>
                    </div>
` : ''}
                </div>
            </div>
`;
                });

                html += `        </div>
`;
            });

            html += `    </div>
</body>
</html>`;

            return html;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function loadFromGitHub() {
            if (!githubSettings.token) {
                alert('‚ùå Bitte erst GitHub Token in Einstellungen hinterlegen!');
                openSettingsModal();
                return;
            }

            if (!confirm('Aktuelle Daten werden √ºberschrieben. Fortfahren?')) return;

            try {
                // ===================================
                // HYBRID-SYSTEM: Part1/2/3 + Module!
                // ===================================
                
                const files = [
                    'academy-content-part1.json',
                    'academy-content-part2.json', 
                    'academy-content-part3.json'
                ];
                
                console.log('üì• Lade 3 Legacy-Dateien + Module von GitHub...');
                
                // Lade alle 3 Dateien parallel
                const promises = files.map(file => 
                    fetch(`https://api.github.com/repos/710Deckel/${githubSettings.repo}/contents/${file}`, {
                        headers: {
                            'Authorization': `token ${githubSettings.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    })
                );
                
                const responses = await Promise.all(promises);
                
                // Pr√ºfe ob alle erfolgreich
                if (!responses.every(r => r.ok)) {
                    alert('‚ùå Eine oder mehrere Dateien nicht gefunden auf GitHub!');
                    return;
                }
                
                // Dekodiere alle Dateien
                const dataArray = await Promise.all(responses.map(r => r.json()));
                const htmlContents = dataArray.map(data => 
                    decodeURIComponent(escape(atob(data.content)))
                );
                
                console.log('‚úÖ Legacy-Dateien geladen!');
                console.log(`Teil 1: ${htmlContents[0].length} Zeichen`);
                console.log(`Teil 2: ${htmlContents[1].length} Zeichen`);
                console.log(`Teil 3: ${htmlContents[2].length} Zeichen`);
                
                // Kombiniere alle 3 HTML-Teile
                let combinedHTML = htmlContents[0]; // Teil 1 mit Header
                
                // Teil 2: Extrahiere nur academy-data Inhalt
                const part2Match = htmlContents[1].match(/<div id="academy-data">([\s\S]*?)<\/div>\s*<\/body>/);
                if (part2Match) {
                    combinedHTML = combinedHTML.replace(/<\/div>\s*<\/body>\s*<\/html>\s*$/, '');
                    combinedHTML += part2Match[1];
                }
                
                // Teil 3: Extrahiere nur academy-data Inhalt
                const part3Match = htmlContents[2].match(/<div id="academy-data">([\s\S]*?)<\/div>\s*<\/body>/);
                if (part3Match) {
                    combinedHTML += part3Match[1];
                }
                
                combinedHTML += '\n    </div>\n</body>\n</html>';
                
                console.log(`‚úÖ Legacy kombiniert: ${combinedHTML.length} Zeichen`);
                
                // Parse HTML und extrahiere Daten
                parseAcademyHTML(combinedHTML);
                
                // ===================================
                // NEU: LADE MODULE-DATEIEN! üöÄ
                // ===================================
                try {
                    console.log('üì• Lade module-technik.json...');
                    const moduleResponse = await fetch(`https://api.github.com/repos/710Deckel/${githubSettings.repo}/contents/module-technik.json`, {
                        headers: {
                            'Authorization': `token ${githubSettings.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (moduleResponse.ok) {
                        const moduleData = await moduleResponse.json();
                        const moduleContent = decodeURIComponent(escape(atob(moduleData.content)));
                        const moduleLektionen = JSON.parse(moduleContent);
                        
                        console.log('‚úÖ module-technik.json geladen:', moduleLektionen.lektionen.length, 'Lektionen');
                        
                        // F√ºge Lektionen zum Technik-Modul hinzu
                        const technikModul = academyData.modules.find(m => m.id === 'technik');
                        if (technikModul && moduleLektionen.lektionen) {
                            moduleLektionen.lektionen.forEach(lek => {
                                // Konvertiere JSON-Format zu internem Format
                                const lektion = {
                                    id: lek.id || `tech_${Date.now()}_${Math.random()}`,
                                    titel: lek.title || lek.titel,
                                    dauer: lek.dauer || 90,
                                    pruefungsrelevant: lek.pruefungsrelevant || false,
                                    status_justin: true,
                                    status_dozent: false,
                                    lernziele: lek.lernziele || [],
                                    inhalt: lek.inhalt || '',
                                    praxisbeispiele: lek.praxisbeispiele || [],
                                    unterrichtsentwurf: '',
                                    didaktik: '',
                                    pruefungsfragen: ''
                                };
                                technikModul.lektionen.push(lektion);
                            });
                            console.log(`‚úÖ ${moduleLektionen.lektionen.length} neue Lektionen zu Technik hinzugef√ºgt!`);
                        }
                    } else {
                        console.log('‚ÑπÔ∏è module-technik.json nicht gefunden');
                    }
                } catch (moduleError) {
                    console.log('‚ÑπÔ∏è Keine Module gefunden:', moduleError.message);
                }
                
                renderModules();
                alert('‚úÖ Erfolgreich geladen! (Legacy + Module) üéâ');
                
            } catch (error) {
                console.error('‚ùå Fehler:', error);
                alert('‚ùå Fehler beim Laden: ' + error.message);
            }
        }

        function parseAcademyHTML(htmlContent) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            
            // Reset data
            academyData.modules.forEach(m => m.lektionen = []);
            
            // Parse modules
            doc.querySelectorAll('.modul').forEach(modulEl => {
                const modulId = modulEl.getAttribute('data-id');
                const modul = academyData.modules.find(m => m.id === modulId);
                if (!modul) return;
                
                modulEl.querySelectorAll('.lektion').forEach(lektionEl => {
                    const lektion = {
                        id: lektionEl.getAttribute('data-id'),
                        titel: lektionEl.querySelector('h3')?.textContent || '',
                        dauer: parseInt(lektionEl.getAttribute('data-dauer')) || 90,
                        pruefungsrelevant: lektionEl.getAttribute('data-pruefung') === 'true',
                        status_justin: lektionEl.getAttribute('data-status-justin') === 'true',
                        status_dozent: lektionEl.getAttribute('data-status-dozent') === 'true',
                        lernziele: [],
                        inhalt_anwaerter: '',
                        beispiele: [],
                        unterrichtsentwurf: '',
                        didaktik: '',
                        pruefungsfragen_text: ''
                    };
                    
                    // Lernziele
                    lektionEl.querySelectorAll('.lernziele .lernziel').forEach(lz => {
                        lektion.lernziele.push(lz.textContent);
                    });
                    
                    // Anw√§rter-Inhalt
                    const anwaerterInhalt = lektionEl.querySelector('.anwaerter .inhalt');
                    if (anwaerterInhalt) {
                        lektion.inhalt_anwaerter = anwaerterInhalt.innerHTML.replace(/<br>/g, '\n');
                    }
                    
                    // Beispiele
                    lektionEl.querySelectorAll('.anwaerter .beispiele .beispiel').forEach(b => {
                        lektion.beispiele.push(b.textContent);
                    });
                    
                    // Dozenten-Inhalte
                    const unterrichtsentwurf = lektionEl.querySelector('.dozent .unterrichtsentwurf .inhalt');
                    if (unterrichtsentwurf) {
                        lektion.unterrichtsentwurf = unterrichtsentwurf.innerHTML.replace(/<br>/g, '\n');
                    }
                    
                    const didaktik = lektionEl.querySelector('.dozent .didaktik .inhalt');
                    if (didaktik) {
                        lektion.didaktik = didaktik.innerHTML.replace(/<br>/g, '\n');
                    }
                    
                    const pruefungsfragen = lektionEl.querySelector('.dozent .pruefungsfragen .inhalt');
                    if (pruefungsfragen) {
                        lektion.pruefungsfragen_text = pruefungsfragen.innerHTML.replace(/<br>/g, '\n');
                    }
                    
                    modul.lektionen.push(lektion);
                });
            });
        }

        // ======================
        // PRINT MODAL & FUNCTIONS
        // ======================
        function openPrintModal() {
            document.getElementById('printModal').classList.add('active');
            renderPrintSelection();
        }

        function closePrintModal() {
            document.getElementById('printModal').classList.remove('active');
        }

        function renderPrintSelection() {
            const container = document.getElementById('printSelection');
            container.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <label class="checkbox-label">
                        <input type="checkbox" id="printAll" onchange="togglePrintAll(this.checked)">
                        <span><strong>Alles ausw√§hlen</strong></span>
                    </label>
                </div>
            `;

            academyData.modules.forEach(modul => {
                if (modul.lektionen.length === 0) return;
                
                const modulDiv = document.createElement('div');
                modulDiv.className = 'print-module';
                modulDiv.innerHTML = `
                    <div class="print-module-header">
                        <label class="checkbox-label">
                            <input type="checkbox" class="print-module-checkbox" data-module="${modul.id}" onchange="toggleModulePrint('${modul.id}', this.checked)">
                            <span><strong>${modul.icon} ${modul.name}</strong> (${modul.lektionen.length} Lektionen)</span>
                        </label>
                    </div>
                    ${modul.lektionen.map(lektion => `
                        <div class="print-lektion">
                            <label class="checkbox-label">
                                <input type="checkbox" class="print-lektion-checkbox" data-modul="${modul.id}" data-lektion="${lektion.id}">
                                <span>${lektion.titel || 'Neue Lektion'}</span>
                            </label>
                        </div>
                    `).join('')}
                `;
                container.appendChild(modulDiv);
            });
        }

        function togglePrintAll(checked) {
            document.querySelectorAll('.print-module-checkbox, .print-lektion-checkbox').forEach(cb => {
                cb.checked = checked;
            });
        }

        function toggleModulePrint(modulId, checked) {
            document.querySelectorAll(`.print-lektion-checkbox[data-modul="${modulId}"]`).forEach(cb => {
                cb.checked = checked;
            });
        }

        async function executePrint() {
            const printAnwaerter = document.getElementById('printAnwaerter').checked;
            const printDozent = document.getElementById('printDozent').checked;
            
            const selectedLektionen = [];
            document.querySelectorAll('.print-lektion-checkbox:checked').forEach(cb => {
                const modulId = cb.getAttribute('data-modul');
                const lektionId = cb.getAttribute('data-lektion');
                const modul = academyData.modules.find(m => m.id === modulId);
                if (modul) {
                    const lektion = modul.lektionen.find(l => l.id === lektionId);
                    if (lektion) {
                        selectedLektionen.push({ modul, lektion });
                    }
                }
            });

            if (selectedLektionen.length === 0) {
                alert('‚ùå Bitte w√§hle mindestens eine Lektion zum Drucken aus!');
                return;
            }

            closePrintModal();
            
            // Generiere PDF mit jsPDF
            await generatePDF(selectedLektionen, printAnwaerter, printDozent);
        }

        async function generatePDF(selectedLektionen, printAnwaerter, printDozent) {
            // Lade jsPDF dynamisch
            if (typeof window.jspdf === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                document.head.appendChild(script);
                
                await new Promise(resolve => {
                    script.onload = resolve;
                });
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4',
                compress: true
            });

            // Funktion um nur Emojis zu entfernen - sonst NICHTS √§ndern!
            function removeEmojis(text) {
                if (!text) return '';
                return text
                    // Nur Emojis entfernen
                    .replace(/[\u{1F300}-\u{1F9FF}]/gu, '')
                    .replace(/[\u{2600}-\u{26FF}]/gu, '')
                    .replace(/[\u{2700}-\u{27BF}]/gu, '');
            }

            let yPos = 20;
            const pageWidth = 210;
            const pageHeight = 297;
            const margin = 20;
            const maxWidth = pageWidth - (2 * margin);
            const lineHeight = 6;
            
            // Header
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('FL Mastery Academy', margin, yPos);
            yPos += 7;
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('Fahrlehrerausbildung - Unterrichtsinhalte', margin, yPos);
            yPos += 5;
            doc.text(new Date().toLocaleDateString('de-DE'), margin, yPos);
            yPos += 10;
            
            // Trennlinie
            doc.setDrawColor(102, 126, 234);
            doc.setLineWidth(0.5);
            doc.line(margin, yPos, pageWidth - margin, yPos);
            yPos += 8;

            // Lektionen
            for (let i = 0; i < selectedLektionen.length; i++) {
                const { modul, lektion } = selectedLektionen[i];
                
                // Check if we need a new page
                if (yPos > pageHeight - 40) {
                    addFooter(doc, pageHeight);
                    doc.addPage();
                    yPos = 20;
                }
                
                // Lektionstitel (Emojis entfernen)
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                const modulName = removeEmojis(modul.name);
                const title = `${modulName} - ${lektion.titel}`;
                doc.text(title, margin, yPos);
                yPos += 7;
                
                // Dauer & Pr√ºfung
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                let meta = `Dauer: ${lektion.dauer} Minuten`;
                if (lektion.pruefungsrelevant) {
                    meta += ' | Pruefungsrelevant';
                }
                doc.text(meta, margin, yPos);
                yPos += 8;
                
                // Lernziele
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('Lernziele', margin, yPos);
                yPos += 6;
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                lektion.lernziele.forEach(lernziel => {
                    if (yPos > pageHeight - 40) {
                        addFooter(doc, pageHeight);
                        doc.addPage();
                        yPos = 20;
                    }
                    const cleanLernziel = removeEmojis(lernziel);
                    const lines = doc.splitTextToSize(`‚Ä¢ ${cleanLernziel}`, maxWidth - 5);
                    lines.forEach(line => {
                        doc.text(line, margin + 3, yPos);
                        yPos += lineHeight;
                    });
                });
                yPos += 3;
                
                // Anw√§rter-Inhalt
                if (printAnwaerter) {
                    if (yPos > pageHeight - 40) {
                        addFooter(doc, pageHeight);
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Inhalt fuer Anwaerter', margin, yPos);
                    yPos += 6;
                    
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    const cleanInhalt = removeEmojis(lektion.inhalt_anwaerter || '');
                    const inhaltLines = doc.splitTextToSize(cleanInhalt, maxWidth);
                    inhaltLines.forEach(line => {
                        if (yPos > pageHeight - 40) {
                            addFooter(doc, pageHeight);
                            doc.addPage();
                            yPos = 20;
                        }
                        doc.text(line, margin, yPos);
                        yPos += lineHeight;
                    });
                    yPos += 3;
                    
                    // Beispiele
                    if (lektion.beispiele.filter(b => b.trim()).length > 0) {
                        if (yPos > pageHeight - 40) {
                            addFooter(doc, pageHeight);
                            doc.addPage();
                            yPos = 20;
                        }
                        
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Praxisbeispiele', margin, yPos);
                        yPos += 6;
                        
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'normal');
                        
                        lektion.beispiele.filter(b => b.trim()).forEach(beispiel => {
                            if (yPos > pageHeight - 40) {
                                addFooter(doc, pageHeight);
                                doc.addPage();
                                yPos = 20;
                            }
                            
                            const cleanBeispiel = removeEmojis(beispiel);
                            
                            // Box f√ºr Beispiel
                            doc.setFillColor(245, 245, 245);
                            const beispielLines = doc.splitTextToSize(cleanBeispiel, maxWidth - 10);
                            const boxHeight = (beispielLines.length * lineHeight) + 4;
                            doc.rect(margin, yPos - 3, maxWidth, boxHeight, 'F');
                            doc.setDrawColor(102, 126, 234);
                            doc.setLineWidth(0.8);
                            doc.line(margin, yPos - 3, margin, yPos - 3 + boxHeight);
                            
                            beispielLines.forEach(line => {
                                doc.text(line, margin + 3, yPos);
                                yPos += lineHeight;
                            });
                            yPos += 5;
                        });
                    }
                }
                
                // Dozenten-Inhalt
                if (printDozent) {
                    if (yPos > pageHeight - 40) {
                        addFooter(doc, pageHeight);
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Dozenten-Inhalte', margin, yPos);
                    yPos += 6;
                    
                    doc.setFontSize(10);
                    
                    if (lektion.unterrichtsentwurf) {
                        doc.setFont('helvetica', 'bold');
                        doc.text('Unterrichtsentwurf:', margin, yPos);
                        yPos += 6;
                        doc.setFont('helvetica', 'normal');
                        const cleanEntwurf = removeEmojis(lektion.unterrichtsentwurf);
                        const lines = doc.splitTextToSize(cleanEntwurf, maxWidth);
                        lines.forEach(line => {
                            if (yPos > pageHeight - 40) {
                                addFooter(doc, pageHeight);
                                doc.addPage();
                                yPos = 20;
                            }
                            doc.text(line, margin, yPos);
                            yPos += lineHeight;
                        });
                        yPos += 3;
                    }
                    
                    if (lektion.didaktik) {
                        if (yPos > pageHeight - 40) {
                            addFooter(doc, pageHeight);
                            doc.addPage();
                            yPos = 20;
                        }
                        doc.setFont('helvetica', 'bold');
                        doc.text('Didaktische Hinweise:', margin, yPos);
                        yPos += 6;
                        doc.setFont('helvetica', 'normal');
                        const cleanDidaktik = removeEmojis(lektion.didaktik);
                        const lines = doc.splitTextToSize(cleanDidaktik, maxWidth);
                        lines.forEach(line => {
                            if (yPos > pageHeight - 40) {
                                addFooter(doc, pageHeight);
                                doc.addPage();
                                yPos = 20;
                            }
                            doc.text(line, margin, yPos);
                            yPos += lineHeight;
                        });
                        yPos += 3;
                    }
                    
                    if (lektion.pruefungsfragen_text) {
                        if (yPos > pageHeight - 40) {
                            addFooter(doc, pageHeight);
                            doc.addPage();
                            yPos = 20;
                        }
                        doc.setFont('helvetica', 'bold');
                        doc.text('Pruefungsfragen:', margin, yPos);
                        yPos += 6;
                        doc.setFont('helvetica', 'normal');
                        const cleanFragen = removeEmojis(lektion.pruefungsfragen_text);
                        const lines = doc.splitTextToSize(cleanFragen, maxWidth);
                        lines.forEach(line => {
                            if (yPos > pageHeight - 40) {
                                addFooter(doc, pageHeight);
                                doc.addPage();
                                yPos = 20;
                            }
                            doc.text(line, margin, yPos);
                            yPos += lineHeight;
                        });
                        yPos += 3;
                    }
                }
                
                // Trennlinie zwischen Lektionen
                if (i < selectedLektionen.length - 1) {
                    if (yPos > pageHeight - 40) {
                        addFooter(doc, pageHeight);
                        doc.addPage();
                        yPos = 20;
                    }
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.3);
                    doc.line(margin, yPos, pageWidth - margin, yPos);
                    yPos += 8;
                }
            }
            
            // Footer auf letzter Seite
            addFooter(doc, pageHeight);
            
            // PDF speichern
            const filename = `Academy_Inhalte_${new Date().toLocaleDateString('de-DE').replace(/\./g, '-')}.pdf`;
            doc.save(filename);
            
            alert('‚úÖ PDF wurde erstellt und heruntergeladen!');
        }

        function addFooter(doc, pageHeight) {
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(100, 100, 100);
            const footerText = 'FL-BE_07/25_Justin_Lee_Probis';
            const textWidth = doc.getTextWidth(footerText);
            doc.text(footerText, (210 - textWidth) / 2, pageHeight - 10);
            doc.setTextColor(0, 0, 0);
        }

        // Reset nach Druck - nicht mehr n√∂tig mit jsPDF
        // PDF wird direkt heruntergeladen
    </script>
</body>
</html>