<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéì Academy Content Editor - FL Mastery</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 2rem;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: white;
            color: #667eea;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-secondary {
            background: #718096;
            color: white;
        }

        .btn-warning {
            background: #ed8936;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            height: calc(100vh - 150px);
        }

        .sidebar {
            background: #f7fafc;
            border-right: 2px solid #e2e8f0;
            overflow-y: auto;
            padding: 20px;
        }

        .module-section {
            margin-bottom: 30px;
        }

        .module-header {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 15px;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .module-header:hover {
            background: #edf2f7;
        }

        .lektion-item {
            padding: 12px;
            margin-bottom: 8px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .lektion-item:hover {
            border-color: #667eea;
            transform: translateX(5px);
        }

        .lektion-item.active {
            border-color: #667eea;
            background: #edf2f7;
        }

        .lektion-title {
            font-weight: 600;
            color: #2d3748;
            font-size: 0.9rem;
        }

        .lektion-status {
            display: flex;
            gap: 5px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #cbd5e0;
        }

        .status-dot.checked {
            background: #48bb78;
        }

        .add-lektion-btn {
            width: 100%;
            margin-top: 10px;
            padding: 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .add-lektion-btn:hover {
            background: #5568d3;
        }

        .editor-area {
            padding: 30px;
            overflow-y: auto;
        }

        .empty-state {
            text-align: center;
            padding: 100px 20px;
            color: #718096;
        }

        .empty-state-icon {
            font-size: 5rem;
            margin-bottom: 20px;
        }

        .editor-section {
            margin-bottom: 30px;
        }

        .editor-section h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.3s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            min-height: 200px;
            resize: vertical;
        }

        .checkbox-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            user-select: none;
        }

        .checkbox-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .lernziele-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .lernziel-item {
            display: flex;
            gap: 10px;
        }

        .lernziel-item input {
            flex: 1;
        }

        .lernziel-item button {
            padding: 10px 15px;
            background: #f56565;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .add-item-btn {
            padding: 10px 20px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
        }

        .beispiele-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .beispiel-item {
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
        }

        .beispiel-item textarea {
            min-height: 100px;
            margin-bottom: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #718096;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border: 2px solid #9ae6b4;
        }

        .alert-info {
            background: #bee3f8;
            color: #2c5282;
            border: 2px solid #90cdf4;
        }

        .print-options {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .print-module {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
        }

        .print-module-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .print-lektion {
            margin-left: 30px;
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .container {
                box-shadow: none;
                border-radius: 0;
            }

            .no-print {
                display: none !important;
            }

            .print-content {
                page-break-inside: avoid;
            }

            .print-lektion-content {
                page-break-inside: avoid;
                margin-bottom: 40px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header no-print">
            <div>
                <h1>üéì Academy Content Editor</h1>
                <p style="margin-top: 5px; opacity: 0.9;">FL Mastery Pro - Fahrlehrerausbildung</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="openSettingsModal()">
                    ‚öôÔ∏è GitHub Setup
                </button>
                <button class="btn btn-warning" onclick="openPrintModal()">
                    üñ®Ô∏è Drucken
                </button>
                <button class="btn btn-primary" onclick="loadFromGitHub()">
                    üì• Laden
                </button>
                <button class="btn btn-success" onclick="saveToGitHub()">
                    üíæ Speichern
                </button>
            </div>
        </div>

        <div class="main-content no-print">
            <div class="sidebar">
                <div id="modulesList">
                    <!-- Module werden hier dynamisch eingef√ºgt -->
                </div>
            </div>

            <div class="editor-area">
                <div id="emptyState" class="empty-state">
                    <div class="empty-state-icon">üìö</div>
                    <h2>Willkommen im Academy Editor!</h2>
                    <p style="margin: 20px 0;">Klicke auf "GitHub Setup" um zu starten.</p>
                    <p>Daten werden als <strong>HTML-Datei</strong> auf GitHub gespeichert (wie Gesetze).</p>
                    <div class="alert alert-info" style="margin-top: 30px; text-align: left;">
                        <span style="font-size: 1.5rem;">üí°</span>
                        <div>
                            <strong>Vorteil:</strong> Unbegrenzte Gr√∂√üe! HTML kann beliebig gro√ü werden.<br>
                            Die App l√§dt die HTML-Datei direkt von GitHub - genau wie bei den Gesetzen!
                        </div>
                    </div>
                </div>

                <div id="editorContent" style="display: none;">
                    <!-- Editor wird hier angezeigt -->
                </div>
            </div>
        </div>

        <!-- PRINT AREA -->
        <div id="printArea" style="display: none;">
            <!-- Druck-Inhalt wird hier generiert -->
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è GitHub Einstellungen</h2>
                <button class="modal-close" onclick="closeSettingsModal()">√ó</button>
            </div>
            
            <div class="form-group">
                <label>GitHub Token (Personal Access Token)</label>
                <input type="password" id="githubToken" placeholder="ghp_...">
                <small style="color: #718096; display: block; margin-top: 5px;">
                    Erstelle einen Token unter: github.com/settings/tokens
                </small>
            </div>

            <div class="form-group">
                <label>Repository Name</label>
                <input type="text" id="repoName" value="FL-Academy-Content">
            </div>

            <div class="form-group">
                <label>Dateiname</label>
                <input type="text" id="fileName" value="academy-content.html">
                <small style="color: #718096; display: block; margin-top: 5px;">
                    Wird als HTML gespeichert (wie Gesetze-Datenbank)
                </small>
            </div>

            <button class="btn btn-success" onclick="saveSettings()" style="width: 100%; margin-top: 20px;">
                ‚úÖ Einstellungen speichern
            </button>
        </div>
    </div>

    <!-- PRINT MODAL -->
    <div class="modal" id="printModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üñ®Ô∏è Druckauswahl</h2>
                <button class="modal-close" onclick="closePrintModal()">√ó</button>
            </div>

            <div class="alert alert-info">
                <span style="font-size: 1.5rem;">üìã</span>
                <div>
                    W√§hle aus, was du drucken m√∂chtest. Der Ausdruck enth√§lt automatisch den FL Mastery Footer.
                </div>
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="printAnwaerter" checked>
                    <span>üìñ Anw√§rter-Inhalte drucken</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="printDozent" checked>
                    <span>üë®‚Äçüè´ Dozenten-Inhalte drucken</span>
                </label>
            </div>

            <div id="printSelection" class="print-options">
                <!-- Auswahloptionen werden hier generiert -->
            </div>

            <div style="display: flex; gap: 10px; margin-top: 30px;">
                <button class="btn btn-success" onclick="executePrint()" style="flex: 1;">
                    üñ®Ô∏è Jetzt drucken
                </button>
                <button class="btn btn-secondary" onclick="closePrintModal()">
                    Abbrechen
                </button>
            </div>
        </div>
    </div>

    <script>
        // ======================
        // GLOBALE VARIABLEN
        // ======================
        let academyData = {
            modules: [
                { id: 'verkehrsverhalten', name: 'Verkehrsverhalten', icon: 'üöó', lektionen: [] },
                { id: 'recht', name: 'Recht', icon: '‚öñÔ∏è', lektionen: [] },
                { id: 'technik', name: 'Technik', icon: 'üîß', lektionen: [] },
                { id: 'unterrichten', name: 'Unterrichten', icon: 'üìö', lektionen: [] },
                { id: 'ausbilden', name: 'Ausbilden', icon: 'üë®‚Äçüè´', lektionen: [] },
                { id: 'weiterbilden', name: 'Weiterbilden', icon: 'üéì', lektionen: [] },
                { id: 'erziehen', name: 'Erziehen', icon: 'üå±', lektionen: [] },
                { id: 'pruefungsfragen', name: 'Pr√ºfungsfragen', icon: 'üìù', lektionen: [] },
                { id: 'beurteilen', name: 'Beurteilen', icon: 'üìä', lektionen: [] }
            ]
        };

        let currentLektion = null;
        let githubSettings = {
            token: localStorage.getItem('github_token') || '',
            repo: localStorage.getItem('github_repo') || 'FL-Academy-Content',
            file: localStorage.getItem('github_file') || 'academy-content.html'
        };

        // ======================
        // INITIALISIERUNG
        // ======================
        window.addEventListener('load', () => {
            renderModules();
            
            if (githubSettings.token) {
                document.getElementById('githubToken').value = githubSettings.token;
                document.getElementById('repoName').value = githubSettings.repo;
                document.getElementById('fileName').value = githubSettings.file;
            }

            console.log('üéì Academy Editor geladen - HTML-Speicher-Modus!');
        });

        // ======================
        // SETTINGS MODAL
        // ======================
        function openSettingsModal() {
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function saveSettings() {
            githubSettings.token = document.getElementById('githubToken').value;
            githubSettings.repo = document.getElementById('repoName').value;
            githubSettings.file = document.getElementById('fileName').value;

            localStorage.setItem('github_token', githubSettings.token);
            localStorage.setItem('github_repo', githubSettings.repo);
            localStorage.setItem('github_file', githubSettings.file);

            alert('‚úÖ Einstellungen gespeichert!');
            closeSettingsModal();
        }

        // ======================
        // RENDER FUNCTIONS (gleich wie vorher)
        // ======================
        function renderModules() {
            const container = document.getElementById('modulesList');
            container.innerHTML = '';

            academyData.modules.forEach(modul => {
                const section = document.createElement('div');
                section.className = 'module-section';

                const header = document.createElement('div');
                header.className = 'module-header';
                header.innerHTML = `
                    <span>${modul.icon}</span>
                    <span>${modul.name}</span>
                `;
                section.appendChild(header);

                modul.lektionen.forEach((lektion, index) => {
                    const item = document.createElement('div');
                    item.className = 'lektion-item';
                    if (currentLektion && currentLektion.id === lektion.id) {
                        item.classList.add('active');
                    }
                    
                    // Extrahiere Lektionsnummer falls vorhanden
                    let displayTitel = lektion.titel || 'Neue Lektion';
                    const lektionNummer = index + 1;
                    
                    // F√ºge Nummer hinzu wenn noch nicht vorhanden
                    if (!displayTitel.match(/^Lektion \d+:/i)) {
                        displayTitel = `Lektion ${lektionNummer}: ${displayTitel}`;
                    }
                    
                    item.innerHTML = `
                        <div class="lektion-title">${displayTitel}</div>
                        <div class="lektion-status">
                            <div class="status-dot ${lektion.status_justin ? 'checked' : ''}" title="Justin gepr√ºft"></div>
                            <div class="status-dot ${lektion.status_dozent ? 'checked' : ''}" title="Dozent gepr√ºft"></div>
                        </div>
                    `;
                    
                    item.onclick = () => editLektion(modul.id, index);
                    section.appendChild(item);
                });

                const addBtn = document.createElement('button');
                addBtn.className = 'add-lektion-btn';
                addBtn.textContent = '+ Neue Lektion';
                addBtn.onclick = () => addNewLektion(modul.id);
                section.appendChild(addBtn);

                container.appendChild(section);
            });
        }

        function addNewLektion(modulId) {
            const modul = academyData.modules.find(m => m.id === modulId);
            if (!modul) return;

            const newLektion = {
                id: `${modulId}_${Date.now()}`,
                titel: '',
                dauer: 90,
                pruefungsrelevant: false,
                status_justin: false,
                status_dozent: false,
                lernziele: [''],
                inhalt_anwaerter: '',
                beispiele: [''],
                inhalt_dozent: '',
                unterrichtsentwurf: '',
                didaktik: '',
                pruefungsfragen_text: ''
            };

            modul.lektionen.push(newLektion);
            renderModules();
            editLektion(modulId, modul.lektionen.length - 1);
        }

        function editLektion(modulId, lektionIndex) {
            const modul = academyData.modules.find(m => m.id === modulId);
            if (!modul) return;

            currentLektion = modul.lektionen[lektionIndex];
            currentLektion.moduleId = modulId; // Speichere aktuelles Modul
            currentLektion.lektionIndex = lektionIndex; // Speichere Index
            
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('editorContent').style.display = 'block';

            renderEditor();
            renderModules();
        }

        function renderEditor() {
            if (!currentLektion) return;

            const container = document.getElementById('editorContent');
            container.innerHTML = `
                <div class="editor-section">
                    <h3>üìù Basis-Informationen</h3>
                    
                    <div class="form-group">
                        <label>Titel der Lektion</label>
                        <input type="text" id="titel" value="${currentLektion.titel || ''}" onchange="updateField('titel', this.value)">
                    </div>

                    <div class="form-group">
                        <label>üìÅ Modul (Lektion verschieben)</label>
                        <select id="modulSelect" onchange="changeLektionModule(this.value)" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; background: white;">
                            ${academyData.modules.map(m => `
                                <option value="${m.id}" ${currentLektion.moduleId === m.id ? 'selected' : ''}>
                                    ${m.icon} ${m.name}
                                </option>
                            `).join('')}
                        </select>
                        <small style="color: #718096; display: block; margin-top: 5px;">
                            ‚ö†Ô∏è Beim √Ñndern wird die Lektion ins gew√§hlte Modul verschoben!
                        </small>
                    </div>

                    <div class="form-group">
                        <label>Dauer (Minuten)</label>
                        <input type="number" id="dauer" value="${currentLektion.dauer}" onchange="updateField('dauer', parseInt(this.value))">
                    </div>

                    <div class="form-group">
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" ${currentLektion.pruefungsrelevant ? 'checked' : ''} onchange="updateField('pruefungsrelevant', this.checked)">
                                <span>üî¥ Pr√ºfungsrelevant</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" ${currentLektion.status_justin ? 'checked' : ''} onchange="updateField('status_justin', this.checked)">
                                <span>‚úÖ Von Justin gepr√ºft</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" ${currentLektion.status_dozent ? 'checked' : ''} onchange="updateField('status_dozent', this.checked)">
                                <span>üë®‚Äçüè´ Von Dozent gepr√ºft</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="editor-section">
                    <h3>üéØ Lernziele</h3>
                    <div class="lernziele-list" id="lernzieleList"></div>
                    <button class="add-item-btn" onclick="addLernziel()">+ Lernziel hinzuf√ºgen</button>
                </div>

                <div class="editor-section">
                    <h3>üéì Inhalt f√ºr Anw√§rter</h3>
                    <div class="form-group">
                        <textarea onchange="updateField('inhalt_anwaerter', this.value)">${currentLektion.inhalt_anwaerter || ''}</textarea>
                    </div>
                </div>

                <div class="editor-section">
                    <h3>üí° Praxisbeispiele</h3>
                    <div class="beispiele-list" id="beispieleList"></div>
                    <button class="add-item-btn" onclick="addBeispiel()">+ Beispiel hinzuf√ºgen</button>
                </div>

                <div class="editor-section">
                    <h3>üë®‚Äçüè´ Inhalt f√ºr Dozenten</h3>
                    
                    <div class="form-group">
                        <label>Unterrichtsentwurf</label>
                        <textarea onchange="updateField('unterrichtsentwurf', this.value)">${currentLektion.unterrichtsentwurf || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label>Didaktische Hinweise</label>
                        <textarea onchange="updateField('didaktik', this.value)">${currentLektion.didaktik || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label>Typische Pr√ºfungsfragen</label>
                        <textarea placeholder="Frage 1: ...\\nAntwort: ...\\n\\nFrage 2: ...\\nAntwort: ..." onchange="updateField('pruefungsfragen_text', this.value)">${currentLektion.pruefungsfragen_text || ''}</textarea>
                    </div>
                </div>

                <div style="display: flex; gap: 15px; margin-top: 30px;">
                    <button class="btn btn-secondary" onclick="deleteLektion()">üóëÔ∏è Lektion l√∂schen</button>
                </div>
            `;

            renderLernziele();
            renderBeispiele();
        }

        function renderLernziele() {
            if (!currentLektion) return;
            const container = document.getElementById('lernzieleList');
            container.innerHTML = '';

            currentLektion.lernziele.forEach((lernziel, index) => {
                const item = document.createElement('div');
                item.className = 'lernziel-item';
                item.innerHTML = `
                    <input type="text" value="${lernziel}" onchange="updateLernziel(${index}, this.value)">
                    <button onclick="removeLernziel(${index})">√ó</button>
                `;
                container.appendChild(item);
            });
        }

        function renderBeispiele() {
            if (!currentLektion) return;
            const container = document.getElementById('beispieleList');
            container.innerHTML = '';

            currentLektion.beispiele.forEach((beispiel, index) => {
                const item = document.createElement('div');
                item.className = 'beispiel-item';
                item.innerHTML = `
                    <textarea onchange="updateBeispiel(${index}, this.value)">${beispiel}</textarea>
                    <button class="btn btn-secondary" onclick="removeBeispiel(${index})">üóëÔ∏è Entfernen</button>
                `;
                container.appendChild(item);
            });
        }

        // ======================
        // UPDATE FUNCTIONS
        // ======================
        function updateField(field, value) {
            if (!currentLektion) return;
            currentLektion[field] = value;
            renderModules();
        }

        function changeLektionModule(newModuleId) {
            if (!currentLektion) return;
            
            const oldModuleId = currentLektion.moduleId;
            
            // Pr√ºfe ob Modul wirklich ge√§ndert wurde
            if (oldModuleId === newModuleId) return;
            
            // Frage Nutzer zur Sicherheit
            const oldModule = academyData.modules.find(m => m.id === oldModuleId);
            const newModule = academyData.modules.find(m => m.id === newModuleId);
            
            if (!confirm(`Lektion wirklich von "${oldModule.name}" nach "${newModule.name}" verschieben?`)) {
                // Zur√ºcksetzen wenn abgebrochen
                document.getElementById('modulSelect').value = oldModuleId;
                return;
            }
            
            // Lektion aus altem Modul entfernen
            const oldModuleLektionen = oldModule.lektionen;
            const lektionIndex = oldModuleLektionen.findIndex(l => l.id === currentLektion.id);
            if (lektionIndex !== -1) {
                oldModuleLektionen.splice(lektionIndex, 1);
            }
            
            // Lektion zu neuem Modul hinzuf√ºgen
            currentLektion.moduleId = newModuleId;
            newModule.lektionen.push(currentLektion);
            
            // UI aktualisieren
            renderModules();
            
            alert(`‚úÖ Lektion erfolgreich nach "${newModule.name}" verschoben!`);
        }

        function updateLernziel(index, value) {
            if (!currentLektion) return;
            currentLektion.lernziele[index] = value;
        }

        function addLernziel() {
            if (!currentLektion) return;
            currentLektion.lernziele.push('');
            renderLernziele();
        }

        function removeLernziel(index) {
            if (!currentLektion) return;
            currentLektion.lernziele.splice(index, 1);
            renderLernziele();
        }

        function updateBeispiel(index, value) {
            if (!currentLektion) return;
            currentLektion.beispiele[index] = value;
        }

        function addBeispiel() {
            if (!currentLektion) return;
            currentLektion.beispiele.push('');
            renderBeispiele();
        }

        function removeBeispiel(index) {
            if (!currentLektion) return;
            currentLektion.beispiele.splice(index, 1);
            renderBeispiele();
        }

        function deleteLektion() {
            if (!currentLektion) return;
            if (!confirm('Lektion wirklich l√∂schen?')) return;

            academyData.modules.forEach(modul => {
                const index = modul.lektionen.findIndex(l => l.id === currentLektion.id);
                if (index !== -1) {
                    modul.lektionen.splice(index, 1);
                }
            });

            currentLektion = null;
            renderModules();
            
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('editorContent').style.display = 'none';
            
            alert('‚ö†Ô∏è Lektion gel√∂scht! WICHTIG: Jetzt auf GitHub speichern!');
        }

        // ======================
        // GITHUB INTEGRATION (HTML-Format!)
        // ======================
        async function saveToGitHub() {
            if (!githubSettings.token) {
                alert('‚ùå Bitte erst GitHub Token in Einstellungen hinterlegen!');
                openSettingsModal();
                return;
            }

            if (!confirm('üöÄ Wirklich auf GitHub speichern?\n\n‚úÖ Speichert ALLE 18 JSON-Dateien\n‚úÖ Verschiebungen werden gespeichert!\n‚úÖ Alle √Ñnderungen werden √ºbernommen!')) return;

            try {
                // ===================================
                // üöÄ NEUE LOGIK: SPEICHERE 18 JSON-DATEIEN!
                // ===================================
                
                console.log('üöÄ Starte Speichervorgang...');
                console.log('üìä academyData:', academyData);
                
                // Definition aller 9 Module mit ihren Part-Dateien
                const moduleConfigs = [
                    { 
                        id: 'verkehrsverhalten', 
                        name: 'üöó Verkehrsverhalten',
                        files: ['module-verkehrsverhalten-part1.json', 'module-verkehrsverhalten-part2.json']
                    },
                    { 
                        id: 'recht', 
                        name: '‚öñÔ∏è Recht',
                        files: ['module-recht-part1.json', 'module-recht-part2.json']
                    },
                    { 
                        id: 'technik', 
                        name: 'üîß Technik',
                        files: ['module-technik-part1.json', 'module-technik-part2.json']
                    },
                    { 
                        id: 'unterrichten', 
                        name: 'üìö Unterrichten',
                        files: ['module-unterrichten-part1.json', 'module-unterrichten-part2.json']
                    },
                    { 
                        id: 'ausbilden', 
                        name: 'üë®‚Äçüè´ Ausbilden',
                        files: ['module-ausbilden-part1.json', 'module-ausbilden-part2.json']
                    },
                    { 
                        id: 'weiterbilden', 
                        name: 'üéì Weiterbilden',
                        files: ['module-weiterbilden-part1.json', 'module-weiterbilden-part2.json']
                    },
                    { 
                        id: 'erziehen', 
                        name: 'üå± Erziehen',
                        files: ['module-erziehen-part1.json', 'module-erziehen-part2.json']
                    },
                    { 
                        id: 'pruefungsfragen', 
                        name: 'üìù Pr√ºfungsfragen',
                        files: ['module-pruefungsfragen-part1.json', 'module-pruefungsfragen-part2.json']
                    },
                    { 
                        id: 'beurteilen', 
                        name: 'üìä Beurteilen',
                        files: ['module-beurteilen-part1.json', 'module-beurteilen-part2.json']
                    }
                ];
                
                let totalSaved = 0;
                let totalFailed = 0;
                const results = [];
                
                // Speichere jedes Modul in 2 Parts
                for (const config of moduleConfigs) {
                    try {
                        // Finde Modul in academyData
                        const modul = academyData.modules.find(m => m.id === config.id);
                        
                        if (!modul) {
                            console.warn(`‚ö†Ô∏è Modul ${config.id} nicht gefunden in academyData!`);
                            continue;
                        }
                        
                        console.log(`üì¶ Verarbeite ${config.name}: ${modul.lektionen.length} Lektionen`);
                        
                        // Teile Lektionen in 2 Parts
                        const allLektionen = modul.lektionen || [];
                        const midpoint = Math.ceil(allLektionen.length / 2);
                        
                        const parts = [
                            allLektionen.slice(0, midpoint),
                            allLektionen.slice(midpoint)
                        ];
                        
                        // Speichere beide Parts
                        for (let i = 0; i < 2; i++) {
                            const partLektionen = parts[i];
                            const filename = config.files[i];
                            
                            try {
                                // Erstelle JSON-Daten
                                const partData = {
                                    moduleId: config.id,
                                    moduleName: config.name,
                                    part: i + 1,
                                    totalParts: 2,
                                    version: '3.0.0',
                                    lastUpdate: new Date().toISOString(),
                                    lektionenCount: partLektionen.length,
                                    lektionen: partLektionen.map(l => ({
                                        id: l.id,
                                        titel: l.titel,
                                        dauer: l.dauer || 90,
                                        pruefungsrelevant: l.pruefungsrelevant || false,
                                        status_justin: l.status_justin || '',
                                        status_dozent: l.status_dozent || '',
                                        lernziele: l.lernziele || [],
                                        inhalt_anwaerter: l.inhalt_anwaerter || l.inhalt || '',
                                        beispiele: l.beispiele || l.praxisbeispiele || [],
                                        unterrichtsentwurf: l.unterrichtsentwurf || '',
                                        didaktik: l.didaktik || '',
                                        pruefungsfragen_text: l.pruefungsfragen_text || '',
                                        pruefungsfragen: l.pruefungsfragen || []
                                    }))
                                };
                                
                                const jsonContent = JSON.stringify(partData, null, 2);
                                const encodedContent = btoa(unescape(encodeURIComponent(jsonContent)));
                                
                                // Hole aktuellen SHA (falls Datei existiert)
                                let sha = null;
                                try {
                                    const getResponse = await fetch(
                                        `https://api.github.com/repos/710Deckel/${githubSettings.repo}/contents/${filename}`,
                                        {
                                            headers: {
                                                'Authorization': `token ${githubSettings.token}`,
                                                'Accept': 'application/vnd.github.v3+json'
                                            }
                                        }
                                    );
                                    if (getResponse.ok) {
                                        const data = await getResponse.json();
                                        sha = data.sha;
                                        console.log(`  üìÑ ${filename} existiert bereits (SHA: ${sha.substring(0, 7)}...)`);
                                    }
                                } catch (e) {
                                    console.log(`  üìù ${filename} wird neu erstellt`);
                                }
                                
                                // Speichere Datei
                                const saveResponse = await fetch(
                                    `https://api.github.com/repos/710Deckel/${githubSettings.repo}/contents/${filename}`,
                                    {
                                        method: 'PUT',
                                        headers: {
                                            'Authorization': `token ${githubSettings.token}`,
                                            'Accept': 'application/vnd.github.v3+json',
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({
                                            message: `Update ${filename} - ${partLektionen.length} Lektionen - ${new Date().toLocaleString('de-DE')}`,
                                            content: encodedContent,
                                            ...(sha && { sha })
                                        })
                                    }
                                );
                                
                                if (saveResponse.ok) {
                                    console.log(`  ‚úÖ ${filename} gespeichert (${partLektionen.length} Lektionen)`);
                                    totalSaved++;
                                    results.push(`‚úÖ ${filename}: ${partLektionen.length} Lektionen`);
                                } else {
                                    const error = await saveResponse.json();
                                    console.error(`  ‚ùå Fehler bei ${filename}:`, error.message);
                                    totalFailed++;
                                    results.push(`‚ùå ${filename}: ${error.message}`);
                                }
                                
                            } catch (partError) {
                                console.error(`  ‚ùå Fehler bei ${filename}:`, partError);
                                totalFailed++;
                                results.push(`‚ùå ${filename}: ${partError.message}`);
                            }
                        }
                        
                    } catch (moduleError) {
                        console.error(`‚ùå Fehler bei Modul ${config.id}:`, moduleError);
                    }
                }
                
                // Zeige Ergebnis
                console.log('\nüìä SPEICHER-ERGEBNIS:');
                console.log(`   ‚úÖ Erfolgreich: ${totalSaved}/18`);
                console.log(`   ‚ùå Fehler: ${totalFailed}/18`);
                console.log('\nDetails:');
                results.forEach(r => console.log(`   ${r}`));
                
                if (totalSaved === 18) {
                    alert(`üéâ PERFEKT! Alle 18 Dateien gespeichert!\n\n‚úÖ Deine Verschiebungen sind jetzt auf GitHub!\n‚úÖ Beim n√§chsten Laden werden sie korrekt angezeigt!`);
                } else if (totalSaved > 0) {
                    alert(`‚ö†Ô∏è Teilweise erfolgreich:\n\n‚úÖ ${totalSaved} Dateien gespeichert\n‚ùå ${totalFailed} Fehler\n\nDetails in der Konsole (F12)`);
                } else {
                    alert(`‚ùå Speichern fehlgeschlagen!\n\nKeine Dateien wurden gespeichert.\nBitte pr√ºfe:\n- GitHub Token\n- Repository Name\n- Internetverbindung\n\nDetails in der Konsole (F12)`);
                }
                
            } catch (error) {
                console.error('‚ùå KRITISCHER FEHLER:', error);
                alert('‚ùå Kritischer Fehler beim Speichern:\n\n' + error.message + '\n\nDetails in der Konsole (F12)');
            }
        }

        function generateAcademyHTML() {
            let html = `<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academy Content - FL Mastery Pro</title>
    <meta name="description" content="Fahrlehrerausbildung Unterrichtsinhalte">
    <meta name="version" content="1.0.0">
    <meta name="last-updated" content="${new Date().toISOString()}">
</head>
<body>
    <div id="academy-data">
`;

            academyData.modules.forEach(modul => {
                if (modul.lektionen.length === 0) return;
                
                html += `
        <!-- ============================================ -->
        <!-- MODUL: ${modul.name.toUpperCase()} -->
        <!-- ============================================ -->
        <div class="modul" data-id="${modul.id}" data-icon="${modul.icon}">
            <h2>${modul.name}</h2>
`;

                modul.lektionen.forEach(lektion => {
                    html += `
            <div class="lektion" 
                 data-id="${lektion.id}" 
                 data-pruefung="${lektion.pruefungsrelevant}"
                 data-dauer="${lektion.dauer}"
                 data-status-justin="${lektion.status_justin}"
                 data-status-dozent="${lektion.status_dozent}">
                
                <h3>${escapeHtml(lektion.titel)}</h3>
                
                <div class="lernziele">
${lektion.lernziele.map(z => `                    <div class="lernziel">${escapeHtml(z)}</div>`).join('\n')}
                </div>
                
                <div class="anwaerter">
                    <h4>Inhalt f√ºr Anw√§rter</h4>
                    <div class="inhalt">${escapeHtml(lektion.inhalt_anwaerter || lektion.inhalt || '').replace(/\n/g, '<br>')}</div>
                    
${(lektion.beispiele || lektion.praxisbeispiele || []).filter(b => b && (typeof b === 'string' ? b.trim() : true)).length > 0 ? `                    <div class="beispiele">
                        <h5>Praxisbeispiele</h5>
${(lektion.beispiele || lektion.praxisbeispiele || []).filter(b => b && (typeof b === 'string' ? b.trim() : true)).map(b => `                        <div class="beispiel">${escapeHtml(typeof b === 'string' ? b : JSON.stringify(b))}</div>`).join('\n')}
                    </div>` : ''}
                </div>
                
                <div class="dozent">
                    <h4>Inhalt f√ºr Dozenten</h4>
                    
${lektion.unterrichtsentwurf ? `                    <div class="unterrichtsentwurf">
                        <h5>Unterrichtsentwurf</h5>
                        <div class="inhalt">${escapeHtml(lektion.unterrichtsentwurf).replace(/\n/g, '<br>')}</div>
                    </div>
` : ''}
${lektion.didaktik ? `                    <div class="didaktik">
                        <h5>Didaktische Hinweise</h5>
                        <div class="inhalt">${escapeHtml(lektion.didaktik).replace(/\n/g, '<br>')}</div>
                    </div>
` : ''}
${lektion.pruefungsfragen_text ? `                    <div class="pruefungsfragen">
                        <h5>Typische Pr√ºfungsfragen</h5>
                        <div class="inhalt">${escapeHtml(lektion.pruefungsfragen_text).replace(/\n/g, '<br>')}</div>
                    </div>
` : ''}
                </div>
            </div>
`;
                });

                html += `        </div>
`;
            });

            html += `    </div>
</body>
</html>`;

            return html;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function loadFromGitHub() {
            if (!githubSettings.token) {
                alert('‚ùå Bitte erst GitHub Token in Einstellungen hinterlegen!');
                openSettingsModal();
                return;
            }

            if (!confirm('Aktuelle Daten werden √ºberschrieben. Fortfahren?')) return;

            try {
                console.log('üì• Lade Module (Part1 + Part2) von GitHub...');
                
                // Reset alle Lektionen
                academyData.modules.forEach(m => m.lektionen = []);
                
                // Modul-Konfiguration (9 Module!)
                const moduleConfigs = [
                    { file: 'module-verkehrsverhalten', moduleId: 'verkehrsverhalten' },
                    { file: 'module-recht', moduleId: 'recht' },
                    { file: 'module-technik', moduleId: 'technik' },
                    { file: 'module-unterrichten', moduleId: 'unterrichten' },
                    { file: 'module-ausbilden', moduleId: 'ausbilden' },
                    { file: 'module-weiterbilden', moduleId: 'weiterbilden' },
                    { file: 'module-erziehen', moduleId: 'erziehen' },
                    { file: 'module-pruefungsfragen', moduleId: 'pruefungsfragen' },
                    { file: 'module-beurteilen', moduleId: 'beurteilen' }
                ];
                
                let modulesLoaded = 0;
                
                // Lade jedes Modul (Part1 + Part2)
                for (const config of moduleConfigs) {
                    const modul = academyData.modules.find(m => m.id === config.moduleId);
                    if (!modul) continue;
                    
                    // Lade Part1
                    try {
                        const part1Response = await fetch(`https://api.github.com/repos/710Deckel/${githubSettings.repo}/contents/${config.file}-part1.json`, {
                            headers: {
                                'Authorization': `token ${githubSettings.token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        });
                        
                        if (part1Response.ok) {
                            const part1Data = await part1Response.json();
                            const part1Content = decodeURIComponent(escape(atob(part1Data.content)));
                            const part1Json = JSON.parse(part1Content);
                            
                            if (part1Json.lektionen && part1Json.lektionen.length > 0) {
                                part1Json.lektionen.forEach(lek => {
                                    const lektion = {
                                        id: lek.id || `${config.moduleId}_${Date.now()}_${Math.random()}`,
                                        titel: lek.title || lek.titel,
                                        dauer: lek.dauer || 90,
                                        pruefungsrelevant: lek.pruefungsrelevant || false,
                                        status_justin: lek.status_justin !== undefined ? lek.status_justin : false,
                                        status_dozent: lek.status_dozent !== undefined ? lek.status_dozent : false,
                                        lernziele: lek.lernziele || [],
                                        inhalt_anwaerter: lek.inhalt_anwaerter || lek.inhalt || '',
                                        beispiele: lek.beispiele || lek.praxisbeispiele || [],
                                        unterrichtsentwurf: lek.unterrichtsentwurf || '',
                                        didaktik: lek.didaktik || '',
                                        pruefungsfragen_text: lek.pruefungsfragen_text || lek.pruefungsfragen || ''
                                    };
                                    modul.lektionen.push(lektion);
                                });
                                console.log(`‚úÖ ${config.file}-part1: ${part1Json.lektionen.length} Lektionen`);
                            }
                        }
                    } catch (e) {
                        console.log(`‚ÑπÔ∏è ${config.file}-part1: Nicht gefunden`);
                    }
                    
                    // Lade Part2
                    try {
                        const part2Response = await fetch(`https://api.github.com/repos/710Deckel/${githubSettings.repo}/contents/${config.file}-part2.json`, {
                            headers: {
                                'Authorization': `token ${githubSettings.token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        });
                        
                        if (part2Response.ok) {
                            const part2Data = await part2Response.json();
                            const part2Content = decodeURIComponent(escape(atob(part2Data.content)));
                            const part2Json = JSON.parse(part2Content);
                            
                            if (part2Json.lektionen && part2Json.lektionen.length > 0) {
                                part2Json.lektionen.forEach(lek => {
                                    const lektion = {
                                        id: lek.id || `${config.moduleId}_${Date.now()}_${Math.random()}`,
                                        titel: lek.title || lek.titel,
                                        dauer: lek.dauer || 90,
                                        pruefungsrelevant: lek.pruefungsrelevant || false,
                                        status_justin: lek.status_justin !== undefined ? lek.status_justin : false,
                                        status_dozent: lek.status_dozent !== undefined ? lek.status_dozent : false,
                                        lernziele: lek.lernziele || [],
                                        inhalt_anwaerter: lek.inhalt_anwaerter || lek.inhalt || '',
                                        beispiele: lek.beispiele || lek.praxisbeispiele || [],
                                        unterrichtsentwurf: lek.unterrichtsentwurf || '',
                                        didaktik: lek.didaktik || '',
                                        pruefungsfragen_text: lek.pruefungsfragen_text || lek.pruefungsfragen || ''
                                    };
                                    modul.lektionen.push(lektion);
                                });
                                console.log(`‚úÖ ${config.file}-part2: ${part2Json.lektionen.length} Lektionen`);
                            }
                        }
                    } catch (e) {
                        console.log(`‚ÑπÔ∏è ${config.file}-part2: Nicht gefunden oder leer`);
                    }
                    
                    if (modul.lektionen.length > 0) {
                        modulesLoaded++;
                    }
                }
                
                console.log(`‚úÖ ${modulesLoaded} Module geladen!`);
                renderModules();
                alert('‚úÖ Erfolgreich geladen! üéâ');
                
            } catch (error) {
                console.error('‚ùå Fehler:', error);
                alert('‚ùå Fehler beim Laden: ' + error.message);
            }
        }

        function parseAcademyHTML(htmlContent) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            
            // Reset data
            academyData.modules.forEach(m => m.lektionen = []);
            
            // Parse modules
            doc.querySelectorAll('.modul').forEach(modulEl => {
                const modulId = modulEl.getAttribute('data-id');
                const modul = academyData.modules.find(m => m.id === modulId);
                if (!modul) return;
                
                modulEl.querySelectorAll('.lektion').forEach(lektionEl => {
                    const lektion = {
                        id: lektionEl.getAttribute('data-id'),
                        titel: lektionEl.querySelector('h3')?.textContent || '',
                        dauer: parseInt(lektionEl.getAttribute('data-dauer')) || 90,
                        pruefungsrelevant: lektionEl.getAttribute('data-pruefung') === 'true',
                        status_justin: lektionEl.getAttribute('data-status-justin') === 'true',
                        status_dozent: lektionEl.getAttribute('data-status-dozent') === 'true',
                        lernziele: [],
                        inhalt_anwaerter: '',
                        beispiele: [],
                        unterrichtsentwurf: '',
                        didaktik: '',
                        pruefungsfragen_text: ''
                    };
                    
                    // Lernziele
                    lektionEl.querySelectorAll('.lernziele .lernziel').forEach(lz => {
                        lektion.lernziele.push(lz.textContent);
                    });
                    
                    // Anw√§rter-Inhalt
                    const anwaerterInhalt = lektionEl.querySelector('.anwaerter .inhalt');
                    if (anwaerterInhalt) {
                        lektion.inhalt_anwaerter = anwaerterInhalt.innerHTML.replace(/<br>/g, '\n');
                    }
                    
                    // Beispiele
                    lektionEl.querySelectorAll('.anwaerter .beispiele .beispiel').forEach(b => {
                        lektion.beispiele.push(b.textContent);
                    });
                    
                    // Dozenten-Inhalte
                    const unterrichtsentwurf = lektionEl.querySelector('.dozent .unterrichtsentwurf .inhalt');
                    if (unterrichtsentwurf) {
                        lektion.unterrichtsentwurf = unterrichtsentwurf.innerHTML.replace(/<br>/g, '\n');
                    }
                    
                    const didaktik = lektionEl.querySelector('.dozent .didaktik .inhalt');
                    if (didaktik) {
                        lektion.didaktik = didaktik.innerHTML.replace(/<br>/g, '\n');
                    }
                    
                    const pruefungsfragen = lektionEl.querySelector('.dozent .pruefungsfragen .inhalt');
                    if (pruefungsfragen) {
                        lektion.pruefungsfragen_text = pruefungsfragen.innerHTML.replace(/<br>/g, '\n');
                    }
                    
                    modul.lektionen.push(lektion);
                });
            });
        }

        // ======================
        // PRINT MODAL & FUNCTIONS
        // ======================
        function openPrintModal() {
            document.getElementById('printModal').classList.add('active');
            renderPrintSelection();
        }

        function closePrintModal() {
            document.getElementById('printModal').classList.remove('active');
        }

        function renderPrintSelection() {
            const container = document.getElementById('printSelection');
            container.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <label class="checkbox-label">
                        <input type="checkbox" id="printAll" onchange="togglePrintAll(this.checked)">
                        <span><strong>Alles ausw√§hlen</strong></span>
                    </label>
                </div>
            `;

            academyData.modules.forEach(modul => {
                if (modul.lektionen.length === 0) return;
                
                const modulDiv = document.createElement('div');
                modulDiv.className = 'print-module';
                modulDiv.innerHTML = `
                    <div class="print-module-header">
                        <label class="checkbox-label">
                            <input type="checkbox" class="print-module-checkbox" data-module="${modul.id}" onchange="toggleModulePrint('${modul.id}', this.checked)">
                            <span><strong>${modul.icon} ${modul.name}</strong> (${modul.lektionen.length} Lektionen)</span>
                        </label>
                    </div>
                    ${modul.lektionen.map(lektion => `
                        <div class="print-lektion">
                            <label class="checkbox-label">
                                <input type="checkbox" class="print-lektion-checkbox" data-modul="${modul.id}" data-lektion="${lektion.id}">
                                <span>${lektion.titel || 'Neue Lektion'}</span>
                            </label>
                        </div>
                    `).join('')}
                `;
                container.appendChild(modulDiv);
            });
        }

        function togglePrintAll(checked) {
            document.querySelectorAll('.print-module-checkbox, .print-lektion-checkbox').forEach(cb => {
                cb.checked = checked;
            });
        }

        function toggleModulePrint(modulId, checked) {
            document.querySelectorAll(`.print-lektion-checkbox[data-modul="${modulId}"]`).forEach(cb => {
                cb.checked = checked;
            });
        }

        async function executePrint() {
            const printAnwaerter = document.getElementById('printAnwaerter').checked;
            const printDozent = document.getElementById('printDozent').checked;
            
            const selectedLektionen = [];
            document.querySelectorAll('.print-lektion-checkbox:checked').forEach(cb => {
                const modulId = cb.getAttribute('data-modul');
                const lektionId = cb.getAttribute('data-lektion');
                const modul = academyData.modules.find(m => m.id === modulId);
                if (modul) {
                    const lektion = modul.lektionen.find(l => l.id === lektionId);
                    if (lektion) {
                        selectedLektionen.push({ modul, lektion });
                    }
                }
            });

            if (selectedLektionen.length === 0) {
                alert('‚ùå Bitte w√§hle mindestens eine Lektion zum Drucken aus!');
                return;
            }

            closePrintModal();
            
            // Generiere PDF mit jsPDF
            await generatePDF(selectedLektionen, printAnwaerter, printDozent);
        }

        async function generatePDF(selectedLektionen, printAnwaerter, printDozent) {
            const loadingMsg = document.createElement('div');
            loadingMsg.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:30px;border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,0.3);z-index:10000;text-align:center;';
            loadingMsg.innerHTML = '<h2>üìÑ PDF wird erstellt...</h2><p>Bitte warten...</p>';
            document.body.appendChild(loadingMsg);
            
            try {
                // Lade pdfmake NUR wenn noch nicht geladen
                if (typeof pdfMake === 'undefined') {
                    loadingMsg.innerHTML = '<h2>üì¶ Lade PDF-Bibliothek...</h2><p>Wird nur beim ersten Mal ben√∂tigt</p>';
                    
                    const script1 = document.createElement('script');
                    script1.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js';
                    document.head.appendChild(script1);
                    
                    await new Promise((resolve, reject) => {
                        script1.onload = resolve;
                        script1.onerror = () => reject(new Error('pdfmake konnte nicht geladen werden'));
                        setTimeout(() => reject(new Error('Timeout')), 15000);
                    });
                    
                    const script2 = document.createElement('script');
                    script2.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.min.js';
                    document.head.appendChild(script2);
                    
                    await new Promise((resolve, reject) => {
                        script2.onload = resolve;
                        script2.onerror = () => reject(new Error('Fonts konnten nicht geladen werden'));
                        setTimeout(() => reject(new Error('Timeout')), 15000);
                    });
                    
                    await new Promise(resolve => setTimeout(resolve, 300));
                }
                
                loadingMsg.innerHTML = '<h2>‚úçÔ∏è Erstelle PDF...</h2><p>Verarbeite Lektionen...</p>';

                // ULTRA TEXT CLEANER
                function clean(text) {
                    if (!text) return '';
                    
                    // HTML Entities MEHRFACH dekodieren (f√ºr &amp;amp;amp;)
                    let decoded = String(text);
                    let lastDecoded = '';
                    let attempts = 0;
                    
                    // Dekodiere bis nichts mehr zu dekodieren ist (max 10x)
                    while (decoded !== lastDecoded && attempts < 10) {
                        lastDecoded = decoded;
                        const div = document.createElement('div');
                        div.innerHTML = decoded;
                        decoded = div.textContent || div.innerText || '';
                        attempts++;
                    }
                    
                    return decoded
                        .replace(/[\u{1F300}-\u{1F9FF}]/gu, '')
                        .replace(/[\u{2600}-\u{26FF}]/gu, '')
                        .replace(/[üéØüìùüí°‚è±Ô∏è‚≠ê]/g, '')
                        // Apostrophe ZUERST normalisieren!
                        .replace(/'/g, "'")
                        .replace(/'/g, "'")
                        .replace(/`/g, "'")
                        .replace(/ º/g, "'")
                        .replace(/¬¥/g, "'")
                        // DANN !' ersetzen
                        .replace(/!\s*'/g, '-> ')
                        .replace(/!'/g, '-> ')
                        // Umlaute - GRO√ü ZUERST!
                        .replace(/√Ñ/g, 'AE')
                        .replace(/√ñ/g, 'OE')
                        .replace(/√ú/g, 'UE')
                        .replace(/√§/g, 'ae')
                        .replace(/√∂/g, 'oe')
                        .replace(/√º/g, 'ue')
                        .replace(/√ü/g, 'ss')
                        // Typografisch
                        .replace(/"/g, '"')
                        .replace(/"/g, '"')
                        .replace(/‚Äì/g, '-')
                        .replace(/‚Äî/g, '-')
                        // Mehrfache Leerzeichen NUR wenn nicht in Tabelle
                        .replace(/\s{3,}/g, '  ')  // 3+ Leerzeichen ‚Üí 2
                        .trim();
                }

                // PDF Content aufbauen
                const content = [];
                
                selectedLektionen.forEach((item, idx) => {
                    const { modul, lektion } = item;
                    
                    if (idx > 0) {
                        content.push({ text: '', pageBreak: 'before' });
                    }
                    
                    // Header
                    content.push({
                        text: 'FL Mastery Academy',
                        style: 'header',
                        color: 'white',
                        fillColor: '#667eea',
                        margin: [0, 0, 0, 10]
                    });
                    
                    // Modul
                    content.push({
                        text: clean(modul.name || 'Modul'),
                        style: 'subheader',
                        margin: [0, 0, 0, 5]
                    });
                    
                    // Titel
                    content.push({
                        text: clean(lektion.titel || 'Ohne Titel'),
                        style: 'title',
                        margin: [0, 0, 0, 5]
                    });
                    
                    // Dauer
                    content.push({
                        text: `Dauer: ${lektion.dauer || 90} Min`,
                        fontSize: 9,
                        margin: [0, 0, 0, 10]
                    });
                    
                    // Lernziele
                    if (lektion.lernziele && lektion.lernziele.length > 0) {
                        content.push({
                            text: 'LERNZIELE',
                            style: 'heading',
                            margin: [0, 10, 0, 5]
                        });
                        
                        lektion.lernziele.forEach((z, i) => {
                            if (z && z.trim()) {
                                content.push({
                                    text: `${i+1}. ${clean(z)}`,
                                    margin: [0, 0, 0, 3]
                                });
                            }
                        });
                    }
                    
                    // Inhalt
                    if (printAnwaerter) {
                        const inhalt = lektion.inhalt_anwaerter || lektion.inhalt || '';
                        if (inhalt.trim()) {
                            content.push({
                                text: 'INHALT FUER ANWAERTER',
                                style: 'heading',
                                margin: [0, 10, 0, 5]
                            });
                            
                            const lines = inhalt.split('\n');
                            lines.forEach(line => {
                                const trimmed = line.trim();
                                if (!trimmed) {
                                    content.push({ text: ' ', fontSize: 6 });
                                    return;
                                }
                                
                                const cleaned = clean(trimmed);
                                
                                // SPEZIAL: Tabellen-Text (viele Gro√übuchstaben ohne Leerzeichen)
                                // z.B. "AUFMERKSAMKEITKONZENTRATIONGrundzustand..."
                                if (cleaned.length > 50 && cleaned.match(/[A-Z]{3,}[A-Z]{3,}/)) {
                                    // F√ºge Leerzeichen vor jedem Gro√übuchstaben nach Kleinbuchstaben
                                    const spaced = cleaned.replace(/([a-z])([A-Z])/g, '$1 $2');
                                    content.push({
                                        text: spaced,
                                        fontSize: 9,
                                        margin: [0, 3, 0, 3]
                                    });
                                }
                                // GROSSBUCHSTABEN
                                else if (trimmed === trimmed.toUpperCase() && trimmed.length > 5 && !trimmed.match(/^\d/)) {
                                    content.push({
                                        text: cleaned,
                                        bold: true,
                                        margin: [0, 5, 0, 3]
                                    });
                                }
                                // Bullets
                                else if (cleaned.startsWith('-') || cleaned.startsWith('‚Ä¢') || cleaned.startsWith('->')) {
                                    content.push({
                                        text: cleaned,
                                        margin: [10, 0, 0, 2]
                                    });
                                }
                                // Normal
                                else {
                                    content.push({
                                        text: cleaned,
                                        margin: [0, 0, 0, 2]
                                    });
                                }
                            });
                        }
                        
                        // Beispiele
                        const beispiele = lektion.beispiele || lektion.praxisbeispiele || [];
                        if (beispiele.length > 0) {
                            content.push({
                                text: 'PRAXISBEISPIELE',
                                style: 'heading',
                                margin: [0, 10, 0, 5]
                            });
                            
                            beispiele.forEach(b => {
                                if (b) {
                                    const text = typeof b === 'string' ? b : JSON.stringify(b);
                                    const lines = text.split('\n');
                                    lines.forEach(line => {
                                        if (line.trim()) {
                                            content.push({
                                                text: `-> ${clean(line)}`,
                                                margin: [0, 0, 0, 3]
                                            });
                                        }
                                    });
                                }
                            });
                        }
                    }
                    
                    // Dozenten
                    if (printDozent) {
                        if (lektion.unterrichtsentwurf && lektion.unterrichtsentwurf.trim()) {
                            content.push({
                                text: 'UNTERRICHTSENTWURF',
                                style: 'heading',
                                margin: [0, 10, 0, 5]
                            });
                            
                            lektion.unterrichtsentwurf.split('\n').forEach(line => {
                                if (line.trim()) {
                                    content.push({
                                        text: clean(line),
                                        margin: [0, 0, 0, 2]
                                    });
                                }
                            });
                        }
                        
                        if (lektion.didaktik && lektion.didaktik.trim()) {
                            content.push({
                                text: 'DIDAKTIK',
                                style: 'heading',
                                margin: [0, 10, 0, 5]
                            });
                            
                            lektion.didaktik.split('\n').forEach(line => {
                                if (line.trim()) {
                                    content.push({
                                        text: clean(line),
                                        margin: [0, 0, 0, 2]
                                    });
                                }
                            });
                        }
                        
                        if (lektion.pruefungsfragen_text && lektion.pruefungsfragen_text.trim()) {
                            content.push({
                                text: 'PRUEFUNGSFRAGEN',
                                style: 'heading',
                                margin: [0, 10, 0, 5]
                            });
                            
                            lektion.pruefungsfragen_text.split('\n').forEach(line => {
                                if (line.trim()) {
                                    content.push({
                                        text: clean(line),
                                        margin: [0, 0, 0, 2]
                                    });
                                }
                            });
                        }
                    }
                });

                // PDF Definition
                const docDefinition = {
                    content: content,
                    styles: {
                        header: {
                            fontSize: 16,
                            bold: true
                        },
                        subheader: {
                            fontSize: 11,
                            color: '#666'
                        },
                        title: {
                            fontSize: 14,
                            bold: true,
                            color: '#667eea'
                        },
                        heading: {
                            fontSize: 12,
                            bold: true
                        }
                    },
                    defaultStyle: {
                        fontSize: 10,
                        lineHeight: 1.3
                    },
                    pageMargins: [40, 60, 40, 60],
                    footer: function(currentPage, pageCount) {
                        return {
                            text: `FL Mastery Academy | Seite ${currentPage} von ${pageCount} | ${new Date().toLocaleDateString('de-DE')}`,
                            alignment: 'center',
                            fontSize: 8,
                            margin: [0, 0, 0, 20]
                        };
                    }
                };

                loadingMsg.innerHTML = '<h2>üíæ Speichere PDF...</h2><p>Gleich fertig!</p>';
                
                pdfMake.createPdf(docDefinition).download(`FL-Academy_${new Date().toLocaleDateString('de-DE').replace(/\./g, '-')}.pdf`);
                
                setTimeout(() => {
                    document.body.removeChild(loadingMsg);
                }, 1000);
                
            } catch (error) {
                loadingMsg.innerHTML = `<h2>‚ùå Fehler!</h2><p>${error.message}</p>`;
                console.error('PDF Fehler:', error);
                setTimeout(() => {
                    document.body.removeChild(loadingMsg);
                }, 3000);
            }
        }
        // PDF wird direkt heruntergeladen
    </script>
</body>
</html>